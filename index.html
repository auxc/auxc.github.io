<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Roboto, sans-serif;
  overflow-y: scroll;
}

li:nth-child(even) { background: rgb(0 0 0 / 0.005)}

li {
  margin-bottom: 15px;
}

#results {
  list-style-type:none;
  padding-left: 0;
  margin-left: 1%;
  margin-right: 1%;
  margin-bottom: 30px; 
}

#tagBox {
  list-style-type:none;
  padding-left: 0;
  margin-left: 1%;
  margin-right: 1%;
  margin-bottom: 2px; 
}


#searchInput {
  flex-grow: 1;
  height= 10px;

  border: 1px solid rgb(0 0 0 / 0.5);
  border-left: 0rem solid green; 
  padding: 8px; 
  box-shadow: 0px 2px 5px rgb(0 0 0 / 0.1);
  border-top-right-radius: 16px;
  border-bottom-right-radius: 16px;
}

#searchInput:focus {
	outline: none;
	box-shadow: inset 0 0 3.5px rgb(0 0 0 / 0.133);
}

.searchContainer {
  display: flex;
  align-content: start;
  height: 30px;
}

#divider {
  border: none;
  height: 0.5px;
  background-color: rgb(0 0 0 / 0.5);
  box-shadow: 0 2.5px 5px rgb(0 0 0 / 0.2);
}

.smallSpace {
    height: 25px;
}

#output {
	font-family:monospace;
}

#footer {
   position: fixed;
   bottom: 0;
   width: 100%;
   height: 20px;
   margin: auto 0;
   background-color: rgb(252 252 252);
   color: rgb(0 0 0 / 0.7);
   text-align: center;
   font-size: medium;
   border-top: 1px solid rgb(0 0 0 / 0.2);
}

.footerLink {
   color: rgb(0 0 0 / 0.8);
}

.tagLink {
  margin-right: 15px;
  white-space: nowrap;
  text-decoration:none;
  color: rgb(255 255 255);
  text-shadow: 0px 1px 3px rgb(64 64 64);
  font-weight: 700;
  line-height: 250%;
  border-radius: 10px;
  border-style: solid;
  border: 1px solid rgb(0 0 0 / 0.3);
  box-shadow: 0px 2px 5px rgb(0 0 0 / 0.1);
  padding: 5px 5px;
}

.tagCounter {
   color: rgb(255 255 255);
   text-decoration:none;
   text-shadow: 0px 2px 50px rgba(220 220 220 255);
   margin-left: 8px;
   padding: 0px 2px;
}

.tagSearchPill {
  white-space: nowrap;
  text-decoration:none;
  color: rgb(255 255 255);
  text-shadow: 0px 1px 3px rgb(64 64 64);
  font-weight: 700;
  border-style: solid;
  border-top: 1px solid rgb(0 0 0 / 0.3);
  border-bottom: 1px solid rgb(0 0 0 / 0.3);
  border-right: 1px solid rgb(0 0 0 / 0.3); 
  border-left: 0rem solid green; 
  
  box-shadow: 0px 2px 5px rgb(0 0 0 / 0.1);
  padding: 5px 5px;
  
  height: 100%;
  position:relative;
  float:left;
  margin: 0 0 2% 0;
}

.mainDropdown {
  padding: 3.5px 6px 15px 10px;
  border-top-left-radius: 16px;
  border-bottom-left-radius: 16px;
  border: 1px double rgb(0 0 0 / 0.4);
}

.mainDropdownIdleAnim {
  background: 
   linear-gradient(rgba(255,0,0,1) 0%, rgba(255,154,0,1) 10%, rgba(208,222,33,1) 20%, rgba(79,220,74,1) 30%, rgba(63,218,216,1) 40%, rgba(47,201,226,1) 50%, rgba(28,127,238,1) 60%, rgba(95,21,242,1) 70%, rgba(186,12,248,1) 80%, rgba(251,7,217,1) 90%, rgba(255,0,0,1) 100%) 
   0 0/100% 200%;
  animation: rainbow 10s linear infinite;
  animation-direction: forward;
}

.logo:hover, logo:active {
  animation: pressDown 0.1s linear 1;
  animation-fill-mode: forwards;
  color: rgb(255 255 255);
  text-shadow: 0px 1px 6px rgb(0 0 0 / 0.3);
  display: inline-block; 
}

.loader {
  border: 6px double #f3f3f3;
  border-top: 6px solid rgb(0 0 0 / 0.66);
  border-radius: 50%;
  width: 33px;
  height: 33px;
  animation: spin 0.33s linear infinite;
  position: absolute;
  top:0;
  bottom: 0;
  left: 0;
  right: 0;
  
  margin: auto;
  z-index: -1;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pressDown {
	0% {
		transform: scale(1);
	}

	100% {
		transform: scale(0.8);
	}
}

@keyframes rainbow{
  to {background-position:0 -200%}
}


</style>
<title>cobweb</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üï∏Ô∏è</text></svg>">
</head>
<body onload="test()">
<center>
<p class = "searchContainer">
<button class="mainDropdown" id="mainButton" onclick="resetSearch()"><span class="logo">üï∏Ô∏è</span></button>
<span id="searchContainerId"></span>
<input oninput="updateResults()" id = "searchInput" placeholder="type to begin"></input>
</p>
</center>
<hr id="divider" />
<ul id='tagBox'>
<div id="init_loader" class="loader"></div>
</ul>
<ul id='results'>
</ul>

<div id="footer">
<small id = "output">v0.2 üï∏Ô∏è cobweb ¬∑ curios found by auxc & friends</small>
</div>

<script>
var url = 'https://raw.githubusercontent.com/auxc/cbwb/main/searchdb.txt';
var storedText;
var searchIndex;

var splitWordsExp = /\(([^)]+)\)/g;
var tagExp =  /([^:\s]+):([^:\s]+)/g;
var globalTags = new Array();
var allTags = new Map();
var tagColorMap = new Map();

var URL = 0;
var NAME = 1;
var DESCRIPTION = 2;
var CATEGORY = 3;
var KEYWORDS = 4;
var HEADER_WORD_COUNT = 5;

function buttonTest(){
	alert("hello");
}

function test(){
var input = document.getElementById('searchInput');
input.addEventListener('keydown', onKeyDown);

fetch(url)
  .then(function(response) {
    response.text().then(function(text) {
      storedText = text;
      done();
    });
  });
}

function done() {
  searchIndex = storedText.split('\n');
  document.getElementById('output').insertAdjacentHTML("beforeend", ` ¬∑ <a class="footerLink" href="searchdb.txt">index(${searchIndex.length})</a>`);
  showAllTags(true);
}

function resetSearch(){
	document.getElementById('searchInput').value = "";
	globalTags.length = 0;
	updateResults();
}

function updateResults() {
  var ul = document.getElementById("results");

  while(ul.firstChild){
    ul.removeChild(ul.firstChild);
  }

  var inputElement = document.getElementById('searchInput');
  var rawInput = inputElement.value;
  var inputStr = rawInput.trim();
  var filterStrings = inputStr.split(' ');
  
  for(var i = 0; i < filterStrings.length; i++){
    var next = filterStrings[i];

    if(next[next.length-1] != ":")
      continue;

    filterStrings.splice(i, 1);
    i--;

    var strippedTag = next.replace(":", "");
    globalTags.push(strippedTag);
  }

  var tagExpPattern = '(?=.*(?:^|\\s)' + globalTags.map(tag => tag.replace(/#/g, '\\#')).join('(?:\\s|$))(?=.*(?:^|\\s)') + '(?:\\s|$))';
  var tagExp = new RegExp(tagExpPattern);
  var anyTags = globalTags.length > 0;

  var showUnrelated = (inputStr.length == 0 && !anyTags)
  showAllTags(showUnrelated);
  updateSearchPills();
  
  //tags moved to pills, update visible input
  var searchTextToDisplay = filterStrings.join(" ");

  if(rawInput.endsWith(" ") && searchTextToDisplay.length > 0)
	searchTextToDisplay += " ";
	
  inputElement.value = searchTextToDisplay;
  
  //focus is for pc only, on mobile the keyboard is annoying
  if (!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
	inputElement.focus({ preventScroll: true });
}

  
  //hack to dump all matching entries if all search words were stripped as tags  
  if(globalTags.length > 0 && (filterStrings.length == 0 || inputStr == "")) {
  	filterStrings = ['('];
  }

  var searchSansTags = filterStrings.join(" ");
  var escapedSearch = searchSansTags.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  var filterExp = new RegExp(`(${escapedSearch})`, 'ig');
  var scoredMatches = new Map();
  
  searchIndex.forEach((entry) => {
	  var matches = [];

	  entry.replace(filterExp, function() {
		  matches.push(Array.prototype.slice.call(arguments, 1).filter(Boolean)); //todo: unvoodoo
	  });
	  
	  matches.forEach((match) => {
		var input = match[0];
		
		var wordAtIndex = getWordAtIndex(match[2], match[1]);
		
		if(!wordAtIndex) //todo: check the null that comes up here sometimes
			return;

		var output = stripParentheses(wordAtIndex, ['(', ')', '.', ',', '\"']);
		
		if(!output)
			return;
		
		if(output.startsWith("http://") || output.startsWith("https://"))
			return;
			
		var wordIndex = countCharacterOccurrences(match[2], ')', 0, match[1]);
		var penaltyMultiplier = 1;
		var flatPenalty = 0;
		
		switch (wordIndex) {
		  case URL:
			penaltyMultiplier = 100;
			break;
		  case NAME:
			penaltyMultiplier = 1;
			break;
		  case DESCRIPTION:
			penaltyMultiplier = 50;
			flatPenalty = 1;
			break;
		  case CATEGORY:
			penaltyMultiplier = 75;
			flatPenalty = 1;
			break;
		  case KEYWORDS:
			penaltyMultiplier = 100;
			flatPenalty = 1;
			break;
		}
		
		var score = -getLevenshteinDistance(input, output) * penaltyMultiplier - flatPenalty;
		
		var scoredMatch = {
			searchTerm: input,
			match: output,
			score: score,
			wordIndex: wordIndex,
			totalMatches: 1,
			line: match[2],
		};
		
		if(scoredMatches.has(match[2])){
			var existing = scoredMatches.get(match[2]);
			existing.totalMatches++;
			
			if(existing.score < score)
				scoredMatches.set(match[2], scoredMatch)
		}
		else
			scoredMatches.set(match[2], scoredMatch)
	  });
  });
  
  var scoredArr = [];
  
  scoredMatches.forEach((value, key) => {
	scoredArr.push(value);
  });
  
  scoredArr.sort((x, y) => {
		return y.score - x.score;
  });

  var showingAny = false;

  scoredArr.forEach((scoredMatch) => {
    if(!scoredMatch)
      return;
		
	var words = scoredMatch.line.match(splitWordsExp);
	var category = stripParentheses(words[CATEGORY], ['(', ')']);
	
	category = category.replaceAll("/", " ");
	
	if(anyTags && !tagExp.test(category))
		return;

    var htmlResult = getResultString(scoredMatch.line);

    if(htmlResult.length == 0)
      return;
      
    var li = document.createElement("li");
    li.insertAdjacentHTML("beforeend", htmlResult);
    ul.appendChild(li);
	showingAny = true;
  });
  
  document.getElementById('mainButton').classList.toggle("mainDropdownIdleAnim", showingAny);
}

function getWordAtIndex(str, index) {
	if(!str)
		return "";

    var words = str.split(/\s+/);
    var currentPosition = 0;
    var currentWord = null;

    for (var i = 0; i < words.length; i++) {
        var endPosition = currentPosition + words[i].length;

        if (index >= currentPosition && index < endPosition) {
            currentWord = words[i];
            break;
        }

        currentPosition = endPosition + 1;
    }

    return currentWord;
}

//https://stackoverflow.com/questions/18516942/fastest-general-purpose-levenshtein-javascript-implementation
function getLevenshteinDistance(s, t) {
    if (s === t) {
        return 0;
    }
    var n = s.length, m = t.length;
    if (n === 0 || m === 0) {
        return n + m;
    }
    var x = 0, y, a, b, c, d, g, h;
    var p = new Uint16Array(n);
    var u = new Uint32Array(n);
    for (y = 0; y < n;) {
        u[y] = s.charCodeAt(y);
        p[y] = ++y;
    }

    for (; (x + 3) < m; x += 4) {
        var e1 = t.charCodeAt(x);
        var e2 = t.charCodeAt(x + 1);
        var e3 = t.charCodeAt(x + 2);
        var e4 = t.charCodeAt(x + 3);
        c = x;
        b = x + 1;
        d = x + 2;
        g = x + 3;
        h = x + 4;
        for (y = 0; y < n; y++) {
            a = p[y];
            if (a < c || b < c) {
                c = (a > b ? b + 1 : a + 1);
            }
            else {
                if (e1 !== u[y]) {
                    c++;
                }
            }

            if (c < b || d < b) {
                b = (c > d ? d + 1 : c + 1);
            }
            else {
                if (e2 !== u[y]) {
                    b++;
                }
            }

            if (b < d || g < d) {
                d = (b > g ? g + 1 : b + 1);
            }
            else {
                if (e3 !== u[y]) {
                    d++;
                }
            }

            if (d < g || h < g) {
                g = (d > h ? h + 1 : d + 1);
            }
            else {
                if (e4 !== u[y]) {
                    g++;
                }
            }
            p[y] = h = g;
            g = d;
            d = b;
            b = c;
            c = a;
        }
    }

    for (; x < m;) {
        var e = t.charCodeAt(x);
        c = x;
        d = ++x;
        for (y = 0; y < n; y++) {
            a = p[y];
            if (a < c || d < c) {
                d = (a > d ? d + 1 : a + 1);
            }
            else {
                if (e !== u[y]) {
                    d = c + 1;
                }
                else {
                    d = c;
                }
            }
            p[y] = d;
            c = a;
        }
        h = d;
    }

    return h;
}

function getResultString(rawResult){
  var url, name, description, category;
  var resultWords = rawResult.match(splitWordsExp);

  if(!resultWords)
    return "";

  for (var i = 0; i < HEADER_WORD_COUNT; i++) { 
    var word = stripParentheses(resultWords[i], ['(', ')']);
    
    switch (i) {
      case URL:
        url = word;
        break;
      case NAME:
        name = word;
        break;
      case DESCRIPTION:
        description = word;
        break;
      case CATEGORY:
        category = word.replaceAll("/", " ");
        break;
      case KEYWORDS:
        break;
    }
  }
  
  var result = `<b><a href='${url}'>${name}</a></b></br><small><sup>${category} ¬∑ ${url}</sup></small></br class='smallSpace'/>${description}`;
  return result;
}

function stripParentheses(str, symbols){

  symbols.forEach((x) => {
    str = str.replaceAll(x,'');
  });

  return str;
}

function countCharacterOccurrences(str, character, startIndex, endIndex) {
    var count = 0;

    for (var i = startIndex; i <= endIndex; i++) {
		if (str[i] === character) {
            count++;
        }
    }

    return count;
}

function showAllTags(includeUnrelated){  

	if(allTags.size == 0){
		  searchIndex.forEach((element) => {
		  if(!element)
			return;
		  
		  addTag(element, allTags);
		});
	}
	
	var sortedKeys = new Array();
	var allSubtags = new Map();
	
	allTags.forEach((tag, key) =>{
		if(globalTags.includes(key)){
			tag.subtagMap.forEach((subTag, subKey) => {
				if(globalTags.includes(subKey))
					return;
					
				if(sortedKeys.includes(subKey))
					return;
					
				if(!subKey) //coming from new map call when constructing maps in add tag, todo: unvoodoo
					return;
				
				allSubtags.set(subKey, subTag);
				sortedKeys.push(subKey);
			});
		}
		else if(includeUnrelated) {
			sortedKeys.push(key);
		}
	});
	
	sortedKeys.sort();

	var tagHtml = "";
	var counter = 0;
	sortedKeys.forEach((key) => {
		var value = allTags.get(key);
		
		if(!value)
			value = allSubtags.get(key);
		
		var color01 = counter / sortedKeys.length;
		tagHtml += getTagLinkHtml(`${key}:`,`${key}`,`${value.val}`, color01, key) + " ";
		counter++;
	});
	
	var ul = document.getElementById("tagBox");

	while(ul.firstChild){
		ul.removeChild(ul.firstChild);
	}

    var li = document.createElement("li");
    li.insertAdjacentHTML("beforeend", tagHtml);
    ul.appendChild(li);
}

function addTag(element, tagMap){
    var CATEGORY = 3; 
    var allWords = element.match(splitWordsExp);
	
	if(!allWords)
		return;
	
    var tagWord = stripParentheses(allWords[CATEGORY], ['(', ')']);

    if(tagWord.length == 0)
      return;
	  
	var tags = tagWord.split(" ");

	tags.forEach((tag) => {
      if(!tag)
        return;
      
      [maintag, subtag] = tag.split('/');
	  
      if(tagMap.has(maintag))
        tagMap.get(maintag).val++;
      else {
		tagMap.set(maintag, {val: 1, subtagMap: new Map()});
	  }
		
	  var t = tagMap.get(maintag);
	  
	  if(t.subtagMap.has(subtag))
		t.subtagMap.get(subtag).val++;
	  else
	    t.subtagMap.set(subtag, {val: 1});
    });
}

function getTagLinkHtml(url, text, suffix, color01, tag){
	var a = [0.5, 0.5, 0.5];
	var b = [0.5, 0.2, 0.3];
	var c = [1.0, 1.0, 1.0];
	var d = [0.0, 0.3, 0.6];
	var bgColor01 = cosinePalette(color01, a, b, c, d);
	var bgColor = `${bgColor01[0]*255} ${bgColor01[1]*255} ${bgColor01[2]*255}`
	
	if(tagColorMap.has(tag))
		tagColorMap.get(tag).color = bgColor;
	else
		tagColorMap.set(tag, {color: bgColor});
	
    return `<a href='${url}' class="tagLink" style="background-color: rgb(${bgColor});" onclick="return resultOnClick(this)">${text}<span class="tagCounter">${suffix}</span></a>`;
}

//https://www.shadertoy.com/view/ll2GD3
function cosinePalette(col01, a, b, c, d) {
    return [
        a[0] + b[0] * Math.cos(6.28318 * (c[0] * col01 + d[0])),
        a[1] + b[1] * Math.cos(6.28318 * (c[1] * col01 + d[1])),
        a[2] + b[2] * Math.cos(6.28318 * (c[2] * col01 + d[2]))
    ];
}

function updateSearchPills(){
	var doc = document.getElementById("searchContainerId");
	var toRemove = new Array();

	for (var i = 0; i < doc.childNodes.length; i++) {
		if (doc.childNodes[i].className == "tagSearchPill") {
			doc.removeChild(doc.childNodes[i]);
			i--;
    }        
}
	globalTags.forEach((x) => {
		var bgColor = "64, 64, 64";
	
		if(tagColorMap.has(x)){
			bgColor = tagColorMap.get(x).color;
		}
	
		var html = getSearchPillHtml(x, bgColor);
		doc.insertAdjacentHTML("beforeend", html)
	});
}

function getSearchPillHtml(tag, bgColor){
    return `<button class="tagSearchPill" onclick="onTagSearchPillClick(this)" style="background-color: rgb(${bgColor});">${tag} √ó</button>`;
}

function resultOnClick(arg){
	var searchString = document.getElementById('searchInput').value;
	searchString = `${arg.getAttribute("href")} ${searchString}`;
    document.getElementById('searchInput').value = searchString;
	updateResults();
	return false;
}

function onTagSearchPillClick(button){
	[tag, unused] = button.textContent.split(" ");
	const index = globalTags.indexOf(tag);
	
	if (index == -1)
		return;
	
	globalTags.splice(index, 1);
	updateResults();
}

function onKeyDown(event) {
    const key = event.key;
	var refreshResults = false;

	console.log();

    if (key === "Backspace") {
		var shouldDelete = event.target.selectionStart == 0 && globalTags.length > 0;
	
		if(shouldDelete){
			globalTags.length = Math.max(globalTags.length - 1, 0);
			refreshResults = true;
		}
    }
	
	if(refreshResults)
		updateResults();
}

</script>
</body>
</html>
