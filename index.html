<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Roboto, sans-serif;
  overflow-y: scroll;
}

li:nth-child(even) { background: rgb(0 0 0 / 0.005)}

li {
  margin-bottom: 15px;
}

#results {
  list-style-type:none;
  padding-left: 0;
  margin-left: 1%;
  margin-right: 1%;
  margin-bottom: 30px; 
}

#searchInput {
  width: 97%;
  border-radius: 5px;
  border: 1px solid rgb(0 0 0 / 0.5);
  padding: 5px; 
  box-shadow: 0px 2px 5px rgb(0 0 0 / 0.1);
}

#divider {
  border: none;
  height: 0.5px;
  background-color: rgb(0 0 0 / 0.5);
  box-shadow: 0 2.5px 5px rgb(0 0 0 / 0.2);
}

.smallSpace {
    height: 25px;
}

#output {
	font-family:monospace;
}

#footer {
   position: fixed;
   bottom: 0;
   width: 100%;
   height: 20px;
   margin: auto 0;
   background-color: rgb(252 252 252);
   color: rgb(0 0 0 / 0.7);
   text-align: center;
   font-size: medium;
   border-top: 1px solid rgb(0 0 0 / 0.2);
}

.footerLink {
   color: rgb(0 0 0 / 0.8);
}

.tagLink {
  margin-right: 15px;
  white-space: nowrap;
  text-decoration:none;
  color: rgb(255 255 255);
  text-shadow: 0px 1px 3px rgb(64 64 64);
  font-weight: 700;
  line-height: 250%;
  background-color: rgb(180 180 180);
  border-radius: 10px;
  border-style: solid;
  border: 1px solid rgb(0 0 0 / 0.3);
  box-shadow: 0px 2px 5px rgb(0 0 0 / 0.1);
  padding: 5px 5px;
}

.tagCounter {
   color: rgb(32 32 32);
   text-decoration:none;
   text-shadow: 0px 1px 0px rgb(220 220 220);
   margin-left: 8px;
   padding: 0px 2px;
}

.loader {
  border: 6px double #f3f3f3;
  border-top: 6px solid rgb(0 0 0 / 0.66);
  border-radius: 50%;
  width: 33px;
  height: 33px;
  animation: spin 0.33s linear infinite;
  position: absolute;
  top:0;
  bottom: 0;
  left: 0;
  right: 0;
  
  margin: auto;
  z-index: -1;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>
<title>cobweb</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üï∏Ô∏è</text></svg>">
</head>
<body onload="test()">
<center><input type="search" oninput="updateResults()" id = "searchInput" placeholder=" type to begin"></center>
<hr id="divider" />
<ul id='results'>
<div id="init_loader" class="loader"></div>
</ul>

<div id="footer">
<small id = "output">v0.2 üï∏Ô∏è cobweb ¬∑ curios found by auxc & friends</small>
</div>

<script>
var url = 'https://raw.githubusercontent.com/auxc/cbwb/main/searchdb.txt';
var storedText;
var searchIndex;

var splitWordsExp = /\(([^)]+)\)/g;
var tagExp =  /([^:\s]+):([^:\s]+)/g;

var URL = 0;
var NAME = 1;
var DESCRIPTION = 2;
var CATEGORY = 3;
var KEYWORDS = 4;
var HEADER_WORD_COUNT = 5;

function test(){
fetch(url)
  .then(function(response) {
    response.text().then(function(text) {
      storedText = text;
      done();
    });
  });
}

function done() {
  searchIndex = storedText.split('\n');
  document.getElementById('output').insertAdjacentHTML("beforeend", ` ¬∑ <a class="footerLink" href="searchdb.txt">index(${searchIndex.length})</a>`);
  showAllTags();
}

function updateResults() {
  var inputStr = document.getElementById('searchInput').value.trim();

  if(inputStr.length == 0){
    showAllTags();
    return;
  }
  
  var filterStrings = inputStr.split(' ');
  var tags = new Array();

  for(var i = 0; i < filterStrings.length; i++){
    var next = filterStrings[i];

    if(next[next.length-1] != ":")
      continue;

    filterStrings.splice(i, 1);
    i--;

    var strippedTag = next.replace(":", "");
    tags.push(strippedTag);
  }

  var tagExpPattern = '(?=.*(?:^|\\s)' + tags.map(tag => tag.replace(/#/g, '\\#')).join('(?:\\s|$))(?=.*(?:^|\\s)') + '(?:\\s|$))';
  var tagExp = new RegExp(tagExpPattern);
  var anyTags = tags.length > 0;
  
  //hack to dump all matching entries if all search words were stripped as tags
  if(filterStrings.length == 0) 
	filterStrings = ['('];

  var searchSansTags = filterStrings.join(" ");
  var escapedSearch = searchSansTags.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  var filterExp = new RegExp(`(${escapedSearch})`, 'ig');
  var scoredMatches = new Map();

  searchIndex.forEach((entry) => {
	  var matches = [];
	  entry.replace(filterExp, function() {
		  matches.push(Array.prototype.slice.call(arguments, 1).filter(Boolean)); //todo: unvoodoo
	  });
	  
	  matches.forEach((match) => {
		var input = match[0];
		var output = stripParentheses(getWordAtIndex(match[2], match[1]), ['(', ')', '.', ',', '\"']);
		
		if(!output)
			return;
		
		if(output.startsWith("http://") || output.startsWith("https://"))
			return;
			
		var wordIndex = countCharacterOccurrences(match[2], ')', 0, match[1]);
		var penaltyMultiplier = 1;
		var flatPenalty = 0;
		
		switch (wordIndex) {
		  case URL:
			penaltyMultiplier = 100;
			break;
		  case NAME:
			penaltyMultiplier = 1;
			break;
		  case DESCRIPTION:
			penaltyMultiplier = 50;
			flatPenalty = 1;
			break;
		  case CATEGORY:
			penaltyMultiplier = 75;
			flatPenalty = 1;
			break;
		  case KEYWORDS:
			penaltyMultiplier = 100;
			flatPenalty = 1;
			break;
		}
		
		var score = -getLevenshteinDistance(input, output) * penaltyMultiplier - flatPenalty;
		
		var scoredMatch = {
			searchTerm: input,
			match: output,
			score: score,
			wordIndex: wordIndex,
			totalMatches: 1,
			line: match[2],
		};
		
		if(scoredMatches.has(match[2])){
			var existing = scoredMatches.get(match[2]);
			existing.totalMatches++;
			
			if(existing.score < score)
				scoredMatches.set(match[2], scoredMatch)
		}
		else
			scoredMatches.set(match[2], scoredMatch)
	  });
  });
  
  var scoredArr = [];
  
  scoredMatches.forEach((value, key) => {
	scoredArr.push(value);
  });
  
  scoredArr.sort((x, y) => {
		return y.score - x.score;
  });
  
  var ul = document.getElementById("results");

  while(ul.firstChild){
    ul.removeChild(ul.firstChild);
  }

  scoredArr.forEach((scoredMatch) => {
    if(!scoredMatch)
      return;
		
	var words = scoredMatch.line.match(splitWordsExp);
	var category = stripParentheses(words[CATEGORY], ['(', ')']);
	
	if(anyTags && !tagExp.test(category))
		return;


    var htmlResult = getResultString(scoredMatch.line);

    if(htmlResult.length == 0)
      return;
      
    var li = document.createElement("li");
    li.insertAdjacentHTML("beforeend", htmlResult);
    ul.appendChild(li);
  });
}

function getWordAtIndex(str, index) {
	if(!str)
		return "";

    var words = str.split(/\s+/);
    var currentPosition = 0;
    var currentWord = null;

    for (var i = 0; i < words.length; i++) {
        var endPosition = currentPosition + words[i].length;

        if (index >= currentPosition && index < endPosition) {
            currentWord = words[i];
            break;
        }

        currentPosition = endPosition + 1;
    }

    return currentWord;
}

//https://stackoverflow.com/questions/18516942/fastest-general-purpose-levenshtein-javascript-implementation
function getLevenshteinDistance(s, t) {
    if (s === t) {
        return 0;
    }
    var n = s.length, m = t.length;
    if (n === 0 || m === 0) {
        return n + m;
    }
    var x = 0, y, a, b, c, d, g, h;
    var p = new Uint16Array(n);
    var u = new Uint32Array(n);
    for (y = 0; y < n;) {
        u[y] = s.charCodeAt(y);
        p[y] = ++y;
    }

    for (; (x + 3) < m; x += 4) {
        var e1 = t.charCodeAt(x);
        var e2 = t.charCodeAt(x + 1);
        var e3 = t.charCodeAt(x + 2);
        var e4 = t.charCodeAt(x + 3);
        c = x;
        b = x + 1;
        d = x + 2;
        g = x + 3;
        h = x + 4;
        for (y = 0; y < n; y++) {
            a = p[y];
            if (a < c || b < c) {
                c = (a > b ? b + 1 : a + 1);
            }
            else {
                if (e1 !== u[y]) {
                    c++;
                }
            }

            if (c < b || d < b) {
                b = (c > d ? d + 1 : c + 1);
            }
            else {
                if (e2 !== u[y]) {
                    b++;
                }
            }

            if (b < d || g < d) {
                d = (b > g ? g + 1 : b + 1);
            }
            else {
                if (e3 !== u[y]) {
                    d++;
                }
            }

            if (d < g || h < g) {
                g = (d > h ? h + 1 : d + 1);
            }
            else {
                if (e4 !== u[y]) {
                    g++;
                }
            }
            p[y] = h = g;
            g = d;
            d = b;
            b = c;
            c = a;
        }
    }

    for (; x < m;) {
        var e = t.charCodeAt(x);
        c = x;
        d = ++x;
        for (y = 0; y < n; y++) {
            a = p[y];
            if (a < c || d < c) {
                d = (a > d ? d + 1 : a + 1);
            }
            else {
                if (e !== u[y]) {
                    d = c + 1;
                }
                else {
                    d = c;
                }
            }
            p[y] = d;
            c = a;
        }
        h = d;
    }

    return h;
}

function getResultString(rawResult){
  var url, name, description, category;
  var resultWords = rawResult.match(splitWordsExp);

  if(!resultWords)
    return "";

  for (var i = 0; i < HEADER_WORD_COUNT; i++) { 
    var word = stripParentheses(resultWords[i], ['(', ')']);
    
    switch (i) {
      case URL:
        url = word;
        break;
      case NAME:
        name = word;
        break;
      case DESCRIPTION:
        description = word;
        break;
      case CATEGORY:
        category = word;
        break;
      case KEYWORDS:
        break;
    }
  }
  
  var result = `<b><a href='${url}'>${name}</a></b></br><small><sup>${category} ¬∑ ${url}</sup></small></br class='smallSpace'/>${description}`;
  return result;
}

function stripParentheses(str, symbols){

  symbols.forEach((x) => {
    str = str.replaceAll(x,'');
  });

  return str;
}

function countCharacterOccurrences(str, character, startIndex, endIndex) {
    var count = 0;

    for (var i = startIndex; i <= endIndex; i++) {
		if (str[i] === character) {
            count++;
        }
    }

    return count;
}

function showAllTags(){
    var tagMap = new Map();
  
    searchIndex.forEach((element) => {
      if(!element)
        return;
      
      addTag(element, tagMap);
    });

	var sortedKeys = Array.from(tagMap.keys()).sort();

    var tagHtml = "";
	sortedKeys.forEach((key) => {
		var value = tagMap.get(key);
		tagHtml += getLinkHtml(`${key}:`,`${key}`,`${value.val}`) + " ";
	});
	
	var ul = document.getElementById("results");

	while(ul.firstChild){
		ul.removeChild(ul.firstChild);
	}

    var li = document.createElement("li");
    li.insertAdjacentHTML("beforeend", tagHtml);
    ul.appendChild(li);
}

function addTag(element, tagMap){
    var CATEGORY = 3; 
    var allWords = element.match(splitWordsExp);
	
	if(!allWords)
		return;
	
    var tagWord = stripParentheses(allWords[CATEGORY], ['(', ')']);

    if(tagWord.length == 0)
      return;
	  
	var tags = tagWord.split(" ");

	tags.forEach((tag) => {
      if(!tag)
        return;
      
      if(tagMap.has(tag))
        tagMap.get(tag).val++;
      else
        tagMap.set(tag, {val: 1})
    });
}

function getLinkHtml(url, text, suffix){
    return `<a href='${url}' class="tagLink" onclick="return resultOnClick(this)">${text}<span class="tagCounter">${suffix}</span></a>`;
}

function resultOnClick(arg){
    document.getElementById('searchInput').value = arg.getAttribute("href");
	updateResults();
	return false;
}
</script>
</body>
</html>
